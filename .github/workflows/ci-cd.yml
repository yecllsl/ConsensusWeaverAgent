name: CI/CD - ConsensusWeaverAgent

# 工作流触发条件
on:
  # 代码推送到main或develop分支
  push:
    branches: [ main ]
  # Pull Request到main分支
  pull_request:
    branches: [ main ]
  # 允许手动触发
  workflow_dispatch:

# 环境变量设置
env:
  PYTHON_VERSION: "3.12"
  UV_VERSION: "0.9.0"
  PROJECT_DIR: "."
  UV_INDEX_URL: "https://pypi.org/simple"
  # 测试覆盖率阈值
  COVERAGE_THRESHOLD: "70"

# 作业定义
jobs:
  # 1. 代码质量检查作业
  quality-check:
    # 运行环境
    runs-on: ubuntu-latest
    
    # 步骤定义
    steps:
      # 1.1 检出代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1.2 设置Python环境
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      # 1.3 安装uv依赖管理工具
      - name: Install uv dependency manager
        run: |
          python -m pip install uv==${{ env.UV_VERSION }}

      # 1.4 安装项目依赖
      - name: Install project dependencies
        run: |
          uv pip install -e . --group dev --system

      # 1.5 代码格式检查
      - name: Check code format with ruff
        run: |
          uv run ruff check --output-format=github .

      # 1.6 代码格式化
      - name: Format code with ruff
        run: |
          uv run ruff format .

      # 1.7 类型检查
      - name: Type check with mypy
        run: |
          uv run mypy src/

      # 1.8 安全检查
      - name: Run security scan with bandit
        run: |
          uv run bandit -r src/ -f json -o security-report.json || true

      # 1.9 上传安全报告
      - name: Upload security report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: security-report.json

  # 2. 测试作业（多平台）
  test:
    # 运行环境 - 支持多平台
    runs-on: ${{ matrix.os }}
    
    # 矩阵策略
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
      fail-fast: false
    
    # 依赖关系
    needs: quality-check
    
    # 步骤定义
    steps:
      # 2.1 检出代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2.2 设置Python环境
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      # 2.3 安装uv依赖管理工具
      - name: Install uv dependency manager
        run: |
          python -m pip install uv==${{ env.UV_VERSION }}

      # 2.4 创建虚拟环境
      - name: Create virtual environment
        run: |
          uv venv

      # 2.5 安装项目依赖
      - name: Install project dependencies
        run: |
          uv pip install -e . --group dev
          # 安装pytest-cov用于生成覆盖率报告
          uv pip install pytest-cov==5.0.0

      # 2.5.1 macOS 特殊处理：使用 pip 安装预编译的 llama-cpp-python
      - name: Install llama-cpp-python for macOS
        if: runner.os == 'macOS'
        env:
          LLAMA_CPP_PYTHON_SKIP_BUILD: 1
        run: |
          python -m pip install --prefer-binary llama-cpp-python>=0.2.72

      # 2.6 运行测试并生成覆盖率报告
      - name: Run tests with coverage
        run: uv run pytest tests/ -v --tb=short -n auto --cov=src --cov-report=xml --cov-report=html --cov-fail-under=${{ env.COVERAGE_THRESHOLD }}

      # 2.7 上传覆盖率报告
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-${{ matrix.os }}
          path: |
            coverage.xml
            htmlcov/

  # 3. 构建验证作业
  build-verify:
    # 运行环境
    runs-on: ubuntu-latest
    
    # 依赖关系
    needs: test
    
    # 步骤定义
    steps:
      # 3.1 检出代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 3.2 设置Python环境
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      # 3.3 安装uv依赖管理工具
      - name: Install uv dependency manager
        run: |
          python -m pip install uv==${{ env.UV_VERSION }}

      # 3.4 安装项目依赖和构建工具
      - name: Install project dependencies and build tools
        run: |
          uv pip install -e . --group dev --system
          uv pip install build==1.2.0

      # 3.5 构建Wheel包
      - name: Build Wheel package
        run: |
          python -m build --wheel

      # 3.6 验证构建产物
      - name: Verify build artifacts
        run: |
          # 检查Wheel包是否生成
          if [ ! -f dist/*.whl ]; then
            echo "Error: Wheel package not found!"
            exit 1
          fi
          echo "Build verification passed: Wheel package generated successfully!"
          ls -la dist/

      # 3.7 上传构建产物
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: dist/
