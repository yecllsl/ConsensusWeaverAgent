name: CI - ConsensusWeaverAgent

# 工作流触发条件
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  # 允许手动触发
  workflow_dispatch:

# 环境变量设置
env:
  PYTHON_VERSION: "3.12"
  UV_VERSION: "0.9.0"
  PROJECT_DIR: "."
  # 覆盖uv的index-url配置，使用默认PyPI源（CI环境忽略pyproject.toml中的清华源配置）
  UV_INDEX_URL: "https://pypi.org/simple"

# 作业定义
jobs:
  # 构建和测试作业
  build-and-test:
    # 运行环境 - 仅支持Windows
    runs-on: windows-latest
    
    # 步骤定义
    steps:
      # 1. 检出代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. 设置Python环境
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      # 3. 安装uv依赖管理工具
      - name: Install uv dependency manager
        run: |
          python -m pip install uv==${{ env.UV_VERSION }}

      # 4. 安装项目依赖
      - name: Install project dependencies
        run: |
          uv pip install -e . --group dev --system

      # 5. 代码格式检查
      - name: Check code format with ruff
        run: |
          uv run ruff check --output-format=github .

      # 6. 代码格式化
      - name: Format code with ruff
        run: |
          uv run ruff format .

      # 7. 类型检查
      - name: Type check with mypy
        run: |
          uv run mypy --strict src/

      # 8. 运行测试
      - name: Run tests with pytest
        run: |
          uv run pytest tests/ -v --tb=short -n auto

      # 9. 生成测试报告
      - name: Generate test report
        if: always()
        run: |
          uv run pytest tests/ --junitxml=test-results.xml -n auto

      # 10. 上传测试结果
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results.xml

  # 安全检查作业（可选）
  security-check:
    runs-on: windows-latest
    needs: build-and-test
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv and dependencies
        run: |
          python -m pip install uv==${{ env.UV_VERSION }}
          uv pip install -e . --group dev --system

      # 安装并运行安全检查工具bandit
      - name: Run security scan with bandit
        run: |
          uv pip install bandit
          uv run bandit -r src/ -f json -o security-report.json 2>$null || true

      # 上传安全报告
      - name: Upload security report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: security-report.json