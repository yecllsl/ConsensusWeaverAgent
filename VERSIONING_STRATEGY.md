# 版本号管理策略

## 版本控制标准

本项目使用**语义化版本控制**（Semantic Versioning）标准，版本号格式为：

```
X.Y.Z
```

其中：
- **X**（主版本号）：不兼容的API变更
- **Y**（次版本号）：向下兼容的功能性新增
- **Z**（修订号）：向下兼容的问题修正

## 版本号变更规则

### 1. 主版本号 (X)

**增加条件**：
- 不兼容的API变更
- 重大架构调整
- 破坏性变更
- 向后兼容性被打破

**示例**：
- 从1.0.0到2.0.0
- 移除或重命名核心API
- 改变数据库结构

### 2. 次版本号 (Y)

**增加条件**：
- 向下兼容的新功能
- 重要的性能改进
- 新增模块或组件
- 扩展性增强

**示例**：
- 从1.0.0到1.1.0
- 添加新的分析器
- 支持新的报告格式
- 增强缓存机制

### 3. 修订号 (Z)

**增加条件**：
- 向下兼容的bug修复
- 安全补丁
- 性能优化（非重大）
- 文档更新
- 测试覆盖率提升

**示例**：
- 从1.0.0到1.0.1
- 修复内存泄漏
- 解决编码错误
- 改进错误处理

## 预发布版本

对于正在开发中的版本，使用以下格式：

```
X.Y.Z.devN
```

其中：
- **dev**：表示开发版本
- **N**：开发版本号，从0开始递增

**示例**：
- 1.1.0.dev0（1.1.0版本的初始开发版本）
- 1.1.0.dev1（1.1.0版本的第二个开发版本）

## 发布候选版本

对于接近发布的版本，可使用以下格式：

```
X.Y.Z-rcN
```

其中：
- **rc**：表示发布候选版本
- **N**：候选版本号，从1开始递增

**示例**：
- 1.1.0-rc1（1.1.0版本的第一个候选版本）
- 1.1.0-rc2（1.1.0版本的第二个候选版本）

## 补丁版本

对于生产环境的紧急修复，使用以下格式：

```
X.Y.Z.P
```

其中：
- **P**：补丁版本号，从1开始递增

**示例**：
- 1.0.0.1（1.0.0版本的第一个补丁）
- 1.0.0.2（1.0.0版本的第二个补丁）

## 版本号管理流程

### 1. 开发阶段

**操作**：
1. 从main分支创建feature或bugfix分支
2. 在开发过程中，版本号保持为`X.Y.Z.devN`
3. 开发完成后，创建Pull Request
4. 代码审查通过后，合并到main分支

**示例**：
- 开始开发：1.1.0.dev0
- 开发中：1.1.0.dev1, 1.1.0.dev2
- 合并到main：准备发布1.1.0

### 2. 发布准备

**操作**：
1. 在main分支上更新版本号，移除`.devN`后缀
2. 更新CHANGELOG.md，添加版本发布说明
3. 提交版本号变更
4. 创建标签

**示例**：
- 更新版本号：1.1.0.dev2 → 1.1.0
- 提交变更：`chore: bump version to 1.1.0`
- 创建标签：`v1.1.0`

### 3. 版本发布

**操作**：
1. 推送main分支和标签到远程仓库
2. 触发CI/CD流程
3. 构建和发布到PyPI
4. 创建GitHub Release

**示例**：
- 推送：`git push origin main v1.1.0`
- CI/CD：自动构建和发布
- GitHub Release：创建发布说明

### 4. 紧急修复

**操作**：
1. 从main分支创建hotfix分支
2. 修复问题
3. 更新版本号（增加Z值）
4. 更新CHANGELOG.md
5. 创建Pull Request
6. 快速审查并合并到main分支
7. 创建补丁标签
8. 推送并发布

**示例**：
- 创建hotfix分支：`hotfix/critical-security-fix`
- 更新版本号：1.1.0 → 1.1.1
- 创建标签：`v1.1.1`
- 推送：`git push origin main v1.1.1`

### 5. 下一版本准备

**操作**：
1. 在main分支上更新版本号，增加Y值并添加`.dev0`后缀
2. 提交变更
3. 开始下一个版本的开发

**示例**：
- 发布1.1.0后，更新版本号为1.2.0.dev0
- 提交：`chore: prepare for 1.2.0 development`

## 版本号管理工具

推荐使用以下工具管理版本号：

### 1. 手动管理

**操作**：
1. 编辑`pyproject.toml`文件中的版本号
2. 更新`CHANGELOG.md`
3. 提交变更
4. 创建标签

**示例**：
```bash
# 更新版本号
sed -i 's/version = "1.0.0.dev0"/version = "1.0.0"/' pyproject.toml

# 提交变更
git add pyproject.toml CHANGELOG.md
git commit -m "chore: bump version to 1.0.0"

# 创建标签
git tag -a v1.0.0 -m "Release version 1.0.0"
```

### 2. 自动化工具

**推荐工具**：
- **semantic-release**：自动管理版本号和发布
- **bump2version**：简单的版本号更新工具
- **commitizen**：基于commit message的版本管理

**semantic-release配置示例**：
```json
{
  "branches": ["main"],
  "plugins": [
    "@semantic-release/commit-analyzer",
    "@semantic-release/release-notes-generator",
    "@semantic-release/changelog",
    "@semantic-release/git"
  ]
}
```

## CHANGELOG管理

### CHANGELOG格式

遵循[Keep a Changelog](https://keepachangelog.com/)规范，格式如下：

```markdown
# 版本更新日志

## [X.Y.Z] - YYYY-MM-DD

### 新功能

- 功能1
- 功能2

### 改进

- 改进1
- 改进2

### 修复

- 修复1
- 修复2

### 移除

- 移除1
- 移除2

## [X.Y.Z-1] - YYYY-MM-DD
...
```

### CHANGELOG更新流程

1. **开发过程中**：
   - 在`CHANGELOG.md`的`## [Unreleased]`部分添加变更

2. **发布前**：
   - 将`## [Unreleased]`部分重命名为具体版本号
   - 添加发布日期
   - 在顶部添加新的`## [Unreleased]`部分

3. **发布后**：
   - 保持`## [Unreleased]`部分用于记录新的变更

## 标签管理

### 标签命名格式

```
vX.Y.Z
```

**示例**：
- `v1.0.0`（正式版本）
- `v1.0.0-rc1`（发布候选版本）
- `v1.0.0.1`（补丁版本）

### 标签创建流程

1. **验证版本号**：确保`pyproject.toml`中的版本号正确
2. **创建标签**：
   ```bash
   git tag -a vX.Y.Z -m "Release version X.Y.Z"
   ```
3. **推送标签**：
   ```bash
   git push origin vX.Y.Z
   ```

### 标签管理最佳实践

- **保持标签轻量**：标签只用于版本标记，不包含额外信息
- **保护标签**：在GitHub上设置标签保护规则
- **避免删除标签**：已发布的标签不应删除
- **使用注释标签**：使用`-a`选项创建带注释的标签

## 版本兼容性

### 向后兼容性

- **主版本号**：可能不向后兼容
- **次版本号**：保持向后兼容
- **修订号**：保持向后兼容

### 兼容性声明

在发布说明中明确声明：
- 向后兼容性状态
- 必要的迁移步骤
- 废弃的API
- 推荐的升级路径

## 版本控制工作流程集成

### 与GitHub Flow集成

1. **开发分支**：使用`X.Y.Z.devN`版本号
2. **合并到main**：准备发布版本
3. **发布**：更新为`X.Y.Z`版本号并创建标签
4. **紧急修复**：从main分支创建hotfix分支，更新为`X.Y.Z+1`版本号

### 与CI/CD集成

1. **版本检测**：CI/CD流程自动检测版本号
2. **发布触发**：基于标签触发发布流程
3. **版本验证**：验证发布版本的正确性
4. **部署**：根据版本号部署到相应环境

## 版本管理最佳实践

### 1. 版本号一致性

- 确保`pyproject.toml`中的版本号与标签一致
- 确保CHANGELOG中的版本号与实际发布版本一致
- 避免版本号冲突

### 2. 版本发布频率

- **主版本**：不频繁，通常几个月或更长
- **次版本**：适中，通常每月或每季度
- **修订版本**：根据需要，通常每周或每月
- **补丁版本**：紧急情况下，24小时内

### 3. 版本号规划

- 提前规划版本号变更
- 与产品路线图保持一致
- 考虑API稳定性承诺
- 避免频繁的主版本号变更

### 4. 版本回滚

- 保持完整的标签历史
- 建立版本回滚流程
- 测试回滚过程
- 准备回滚说明

## 常见问题和解决方案

### 1. 版本号冲突

**解决方案**：
- 建立版本号管理流程
- 使用自动化工具管理版本号
- 定期同步版本号

### 2. 标签丢失

**解决方案**：
- 定期备份标签
- 使用Git服务器的标签保护功能
- 建立标签管理规范

### 3. 版本发布延误

**解决方案**：
- 建立发布检查清单
- 自动化发布流程
- 提前规划发布时间

### 4. 版本兼容性问题

**解决方案**：
- 制定兼容性测试计划
- 建立API稳定性承诺
- 提供详细的迁移指南

## 总结

有效的版本号管理：

1. **提高可预测性**：明确版本变更的含义
2. **便于协作**：团队成员了解版本状态
3. **简化部署**：根据版本号部署相应环境
4. **增强可靠性**：通过版本控制确保系统稳定性
5. **提升用户体验**：用户了解版本变更内容

通过遵循本策略，项目将保持清晰的版本管理流程，确保版本号的一致性和可预测性，从而提高开发效率和系统稳定性。