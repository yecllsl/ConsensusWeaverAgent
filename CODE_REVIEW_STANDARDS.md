# 代码审查标准

## 审查目标

代码审查的主要目标是：
1. **提高代码质量**：确保代码符合项目标准和最佳实践
2. **发现潜在问题**：识别安全漏洞、性能问题、逻辑错误
3. **知识共享**：促进团队成员之间的知识交流
4. **确保一致性**：保持代码风格和架构设计的一致性

## 审查标准

### 1. 代码质量

#### 1.1 可读性
- [ ] 代码是否有清晰的命名？
- [ ] 函数和方法是否简短且职责单一？
- [ ] 是否有必要的注释和文档？
- [ ] 代码结构是否清晰易懂？

#### 1.2 可维护性
- [ ] 代码是否易于理解和修改？
- [ ] 是否遵循DRY原则（Don't Repeat Yourself）？
- [ ] 是否使用了适当的设计模式？
- [ ] 是否考虑了未来的扩展？

#### 1.3 代码规范
- [ ] 是否通过ruff代码规范检查？
- [ ] 是否通过ruff代码格式验证？
- [ ] 缩进和空白是否一致？
- [ ] 行长度是否符合88字符的限制？

### 2. 功能正确性

#### 2.1 逻辑正确性
- [ ] 功能是否按预期工作？
- [ ] 边界情况是否处理？
- [ ] 错误处理是否完善？
- [ ] 特殊输入是否有适当的处理？

#### 2.2 性能
- [ ] 是否有明显的性能问题？
- [ ] 数据库查询是否优化？
- [ ] 算法复杂度是否合理？
- [ ] 是否有不必要的计算或操作？

#### 2.3 安全性
- [ ] 是否有安全漏洞？
- [ ] 输入是否经过验证？
- [ ] 是否使用了参数化查询？
- [ ] 是否有敏感信息泄露的风险？

### 3. 测试覆盖

#### 3.1 测试充分性
- [ ] 是否有相应的单元测试？
- [ ] 测试是否覆盖了主要功能？
- [ ] 测试是否覆盖了边界情况？
- [ ] 测试覆盖率是否达到75%以上？

#### 3.2 测试质量
- [ ] 测试是否清晰易懂？
- [ ] 测试是否独立且可重复？
- [ ] 测试是否使用了适当的mock？
- [ ] 测试是否检查了错误情况？

### 4. 文档和注释

#### 4.1 文档完整性
- [ ] 是否更新了相关文档？
- [ ] 是否添加了必要的注释？
- [ ] 是否更新了CHANGELOG？
- [ ] 公共API是否有文档？

#### 4.2 注释质量
- [ ] 注释是否解释了"为什么"而不是"做什么"？
- [ ] 复杂逻辑是否有注释说明？
- [ ] 注释是否清晰准确？
- [ ] 注释是否与代码同步？

## 合并条件

### 必要条件

以下条件必须满足才能合并Pull Request：

1. **CI检查通过**：
   - [ ] 代码规范检查（ruff check）通过
   - [ ] 代码格式验证（ruff format --check）通过
   - [ ] 类型检查（mypy）通过
   - [ ] 安全检查（bandit）通过
   - [ ] 所有测试通过
   - [ ] 测试覆盖率不低于75%

2. **代码审查通过**：
   - [ ] 至少有1个审查者批准
   - [ ] 所有评论已解决
   - [ ] 没有未解决的严重问题

3. **测试覆盖**：
   - [ ] 新功能有相应的测试
   - [ ] 修复有相应的测试
   - [ ] 测试覆盖了主要路径

4. **文档更新**：
   - [ ] 必要的文档已更新
   - [ ] CHANGELOG已更新（如需要）
   - [ ] 注释已添加（如需要）

### 可选条件

以下条件为推荐但非必须：

1. **性能优化**：
   - [ ] 代码性能合理
   - [ ] 没有明显的性能瓶颈

2. **代码风格**：
   - [ ] 代码风格一致
   - [ ] 命名规范统一

3. **可扩展性**：
   - [ ] 代码设计考虑了未来扩展
   - [ ] 接口设计合理

## 审查流程

### 1. 审查者职责

1. **初步检查**：
   - 检查PR标题和描述是否清晰
   - 检查CI检查是否通过
   - 检查测试覆盖率是否达标

2. **详细审查**：
   - 审查代码质量和可维护性
   - 审查功能正确性和安全性
   - 审查测试覆盖和文档

3. **提供反馈**：
   - 提出具体的改进建议
   - 指出潜在的问题
   - 确认符合审查标准

4. **最终决定**：
   - 批准PR（通过所有检查）
   - 要求修改（需要进一步改进）
   - 拒绝PR（严重问题）

### 2. 提交者职责

1. **PR准备**：
   - 提供清晰的PR标题和描述
   - 确保CI检查通过
   - 添加必要的测试和文档

2. **回应反馈**：
   - 及时回应审查者的评论
   - 进行必要的修改
   - 重新运行CI检查

3. **最终确认**：
   - 确认所有问题已解决
   - 确认测试覆盖充分
   - 确认文档已更新

## 审查时间

- **小PR**（< 100行）：1-2个工作日
- **中PR**（100-500行）：2-3个工作日
- **大PR**（> 500行）：3-5个工作日

## 特殊情况

### 紧急修复

对于生产环境的紧急修复：

1. **快速审查**：优先审查，1个工作日内完成
2. **最小改动**：只包含必要的修复，避免额外变更
3. **验证**：确保修复有效且不会引入新问题
4. **部署**：快速合并并部署

### 重构

对于大规模重构：

1. **分阶段**：拆分为多个小PR，便于审查
2. **详细文档**：提供重构的目的和方法
3. **测试覆盖**：确保重构后的代码有充分测试
4. **兼容性**：确保向后兼容

## 最佳实践

### 审查者

- **保持建设性**：提供具体的改进建议，而非单纯批评
- **关注重点**：优先关注安全性、性能和正确性
- **尊重时间**：及时完成审查，避免延误
- **学习分享**：通过审查分享知识和经验

### 提交者

- **保持PR小**：每个PR只包含一个功能或修复
- **提供上下文**：解释代码变更的目的和方法
- **响应及时**：及时处理审查者的反馈
- **测试充分**：确保代码有充分的测试覆盖

## 工具和资源

- **代码审查工具**：GitHub Pull Request
- **代码规范**：ruff
- **类型检查**：mypy
- **安全检查**：bandit
- **测试框架**：pytest
- **覆盖率工具**：pytest-cov

## 常见问题和解决方案

### 1. 审查时间过长

**解决方案**：
- 拆分大型PR为多个小PR
- 提前沟通复杂的变更
- 优先处理紧急的PR

### 2. 审查意见不一致

**解决方案**：
- 讨论不同的观点，寻求共识
- 参考项目标准和最佳实践
- 如无法达成一致，寻求第三方意见

### 3. CI检查失败

**解决方案**：
- 修复CI检查失败的问题
- 确保测试通过
- 确保代码规范和类型检查通过

### 4. 测试覆盖不足

**解决方案**：
- 添加必要的测试
- 优先测试关键路径和边界情况
- 考虑使用测试生成工具

## 总结

代码审查是确保代码质量的重要环节。通过遵循本标准，我们可以：

1. 提高代码质量和可维护性
2. 减少bug和安全漏洞
3. 促进团队成员之间的知识共享
4. 确保项目的长期健康发展

所有团队成员都应该积极参与代码审查，共同维护代码库的质量。