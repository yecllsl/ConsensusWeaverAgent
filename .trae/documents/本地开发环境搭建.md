# 本地开发环境搭建指南

## 1. 环境依赖

### 1.1 系统要求
- Windows 10/11 (64位)
- Python 3.12+
- 至少8GB RAM (推荐16GB以上)
- 至少10GB可用磁盘空间

### 1.2 核心依赖

| 依赖名称 | 版本要求 | 用途 |
|---------|---------|------|
| Python | 3.12+ | 核心编程语言 |
| LangChain | 最新稳定版 | LLM集成框架 |
| llama-cpp-python | 0.2.72+ | 本地LLM服务 |
| Click | 8.1+ | 命令行界面 |
| PyYAML | 6.0+ | 配置管理 |
| SQLite | 3.40+ | 数据持久化 |
| NLTK | 3.8+ | 文本分析 |
| scikit-learn | 1.3+ | 相似度计算 |
| asyncio | 内置 | 异步处理 |
| modelscope | 1.33.0+ | 模型文件下载 |

## 2. 安装步骤

### 2.1 Python环境配置

1. **下载并安装Python**
   - 访问 [Python官网](https://www.python.org/downloads/) 下载Python 3.12+ 安装包
   - 运行安装包，勾选 "Add Python to PATH"
   - 选择 "Customize installation"，确保所有选项都被勾选
   - 完成安装后，打开命令行验证：
     ```powershell
     python --version
     pip --version
     ```

2. **安装现代化依赖管理工具**
   ```powershell
   pip install --upgrade pip
   pip install uv
   ```
   
   **uv** 是一个高性能的Python包管理器，具有以下优势：
   - 比pip快10-100倍
   - 自动管理虚拟环境
   - 内置依赖解析器
   - 支持pep 621标准
   - 自动同步依赖

### 2.2 模型文件下载

1. **使用提供的下载脚本**
   - 项目已提供了模型下载脚本，运行以下命令下载默认模型：
     ```powershell
     python Scripts/download_qwen3-8b-gguf.py
     ```
   - 这个脚本会自动从ModelScope下载Qwen3-8B-Q5_K_M.gguf模型文件到`.models/qwen/`目录

2. **手动下载模型**
   - 如果需要下载其他版本的模型，可以从ModelScope下载：
     - 访问 [Qwen3-8B-GGUF模型页面](https://modelscope.cn/models/Qwen/Qwen3-8B-GGUF/files)
     - 选择需要的模型文件（如Q4_K_M版本、Q8_0版本等）
     - 下载后将模型文件放入项目根目录下的`.models/qwen/`目录

3. **验证模型文件**
   - 下载完成后，确认模型文件已正确放置：
     ```powershell
     ls .models/qwen/
     ```
   - 应该能看到下载的模型文件（如Qwen3-8B-Q5_K_M.gguf）

### 2.3 项目代码与依赖安装

1. **克隆项目代码**
   ```powershell
   git clone <项目仓库地址>
   cd ConsensusWeaverAgent
   ```

2. **创建虚拟环境并安装所有依赖**
   ```powershell
   uv venv && uv sync --all-extras
   ```
   
   这条命令会：
   - 创建一个名为`.venv`的虚拟环境
   - 自动安装项目的所有依赖（包括开发依赖）
   - 确保依赖版本兼容
   
3. **激活虚拟环境**
   ```powershell
   .venv\Scripts\activate
   ```

4. **下载NLTK资源**
   ```powershell
    python -c "import nltk; nltk.data.path.append('https://gitee.com/gislite/nltk_data/raw/'); nltk.download('punkt'); nltk.download('stopwords'); nltk.download('wordnet')"
   ```

## 3. 项目配置

### 3.1 配置文件创建

项目会在首次运行时自动创建默认配置文件 `config.yaml`。如果需要手动创建，可以使用以下命令：

```powershell
# 创建默认配置文件
python -c "from src.infrastructure.config.config_manager import ConfigManager; ConfigManager()"
```

### 3.2 配置文件结构

项目使用YAML格式的配置文件 `config.yaml`，默认配置如下：

```yaml
# 本地LLM配置
local_llm:
  provider: "llama-cpp"      # LLM提供商
  model: "Qwen3-8B-Q5_K_M.gguf"  # 使用的模型名称
  model_path: ".models/qwen/Qwen3-8B-Q5_K_M.gguf"  # 模型文件路径
  n_ctx: 4096                 # 上下文窗口大小
  n_threads: 4                # 推理线程数
  temperature: 0.3            # 生成温度参数

# 外部AI工具配置
external_tools:
  - name: "iflow"            # 工具名称
    command: "iflow"         # 命令名称
    args: "ask --streaming=false"  # 命令参数
    needs_internet: true     # 是否需要互联网
    priority: 1              # 优先级（数字越小优先级越高）
    enabled: true            # 是否启用
  - name: "codebuddy"
    command: "codebuddy"
    args: "ask --format plain"
    needs_internet: true
    priority: 2
    enabled: true

# 网络配置
network:
  check_before_run: true     # 启动前检查网络
  timeout: 60                # 外部工具调用超时时间（秒）

# 应用配置
app:
  max_clarification_rounds: 3  # 最大澄清轮数
  max_parallel_tools: 5        # 最大并发工具数
  log_level: "info"            # 日志级别
  log_file: "consensusweaver.log"  # 日志文件路径
  history_enabled: true        # 是否启用历史记录
  history_limit: 100          # 历史记录限制数量
```

### 3.2 配置说明

- **local_llm**：配置本地LLM服务参数
  - `model`：可根据需要更改为其他GGUF模型文件名称
  - `model_path`：模型文件的路径，可根据实际情况调整
  - `n_ctx`：上下文窗口大小，影响模型能处理的文本长度
  - `n_threads`：推理线程数，可根据CPU核心数调整
  - `temperature`：生成温度参数，影响输出的随机性

- **external_tools**：配置外部AI工具
  - 可以添加或删除工具
  - `enabled`：设置为false可禁用特定工具
  - `priority`：数字越小，优先级越高

- **network**：配置网络相关参数
  - `check_before_run`：设置为false可跳过网络检查
  - `timeout`：可根据网络状况调整

- **app**：配置应用行为
  - `max_clarification_rounds`：最多澄清轮数
  - `max_parallel_tools`：最大并发工具调用数量
  - `log_level`：可选值：debug, info, warning, error, critical

## 4. 项目启动

### 4.1 模型文件准备

确保已完成模型文件下载（参考2.2节），并在config.yaml中正确配置了模型文件路径。

无需启动额外的LLM服务，应用将直接加载本地模型文件。

### 4.2 运行项目

1. **激活虚拟环境**（如果尚未激活）
   ```powershell
   .\venv\Scripts\activate
   ```

2. **运行应用**
   ```powershell
   python -m src.main
   ```

3. **带参数运行**
   ```powershell
   # 指定配置文件
   python -m src.main --config my_config.yaml
   
   # 启用详细日志
   python -m src.main --verbose
   ```

## 5. 开发流程

### 5.1 代码结构

```
src/
├── ui/                     # 用户界面层
├── service/                # 应用服务层
│   ├── interaction/        # 智能交互引擎
│   └── strategy/           # 执行策略管理器
├── core/                   # 核心功能层
│   ├── executor/           # 并发查询执行器
│   ├── analyzer/           # 共识分析引擎
│   └── reporter/           # 报告生成器
├── infrastructure/         # 基础设施层
│   ├── llm/                # LLM集成服务
│   ├── tools/              # 外部工具集成
│   ├── data/               # 数据持久化
│   ├── config/             # 配置管理
│   └── logging/            # 日志系统
├── models/                 # 数据模型
└── utils/                  # 工具函数
```

### 5.2 代码规范

- 使用ruff进行代码格式化和lint检查
  ```powershell
  uv run ruff check .
  uv run ruff format .
  ```
  
  我们使用uv run来运行ruff，确保使用的是虚拟环境中的ruff版本，保证环境一致性。

- 所有函数/方法必须包含完整类型注解
- 复杂结构使用`TypedDict`或`@dataclass`
- 公共模块/类/函数必须包含Google风格docstring

### 5.3 测试流程

- 运行单元测试
  ```powershell
  uv run pytest tests/unit/
  ```

- 运行集成测试
  ```powershell
  uv run pytest tests/integration/
  ```

- 运行所有测试
  ```powershell
  uv run pytest
  ```
  
  我们使用uv run来运行pytest，确保使用的是虚拟环境中的pytest版本，保证环境一致性。

## 6. 常见问题与解决方案

### 6.1 模型加载相关问题

#### 问题1：模型文件路径错误

**错误信息**：`FileNotFoundError: Could not find model file`

**解决方案**：
1. 确认模型文件已正确下载到指定路径
2. 检查config.yaml中的model_path配置是否与实际文件路径一致
3. 确保模型文件权限正确

#### 问题2：模型格式不兼容

**错误信息**：`ValueError: Model file is not a valid GGUF file`

**解决方案**：
1. 确认下载的是GGUF格式的模型文件
2. 检查模型文件是否完整，未被损坏
3. 尝试下载其他版本的模型文件

#### 问题3：内存不足

**错误信息**：`RuntimeError: Not enough memory to load the model`

**解决方案**：
1. 关闭其他占用大量内存的应用程序
2. 尝试使用更小的模型文件（如Q4_K_M版本）
3. 减少config.yaml中的n_ctx值以降低内存使用

#### 问题4：模型下载失败

**错误信息**：`modelscope.utils.file_download.DownloadError: Failed to download file`

**解决方案**：
1. 检查网络连接是否正常
2. 尝试使用代理（如果网络环境需要）
3. 手动从ModelScope下载模型文件并放置到指定目录

### 6.2 Python依赖问题

#### 问题1：模块导入错误

**错误信息**：`ModuleNotFoundError: No module named 'xxx'`

**解决方案**：
1. 确认虚拟环境已激活
2. 安装缺失的依赖：
   ```powershell
   uv install xxx
   ```

#### 问题2：版本冲突

**错误信息**：`ImportError: cannot import name 'xxx' from 'yyy'`

**解决方案**：
1. 升级或降级相关依赖：
   ```powershell
   uv install yyy==version
   ```
2. 查看项目的依赖关系：
   ```powershell
   uv show yyy
   ```

### 6.3 应用运行问题

#### 问题1：外部工具调用失败

**错误信息**：`工具 xxx 执行失败: returncode: 1`

**解决方案**：
1. 确认外部工具已正确安装
2. 检查工具是否需要API密钥或其他配置
3. 检查网络连接（如果工具需要联网）

#### 问题2：内存不足

**错误信息**：`MemoryError` 或 `OOM killed`

**解决方案**：
1. 关闭其他占用内存的程序
2. 使用较小的LLM模型
3. 增加系统内存

## 7. 开发工具推荐

### 7.1 IDE推荐
- **VS Code**：轻量级，插件丰富
  - 推荐插件：Python, Pylance, Ruff, YAML

- **PyCharm**：功能强大，专为Python开发设计
  - 推荐版本：PyCharm Community或Professional

### 7.2 调试工具
- **Python Debugger**：VS Code内置调试器
- **pytest**：测试框架，支持调试

### 7.3 版本控制
- **Git**：代码版本管理
  - 推荐使用GitHub Desktop或SourceTree等图形界面工具

## 8. 联系与支持

如果在环境搭建过程中遇到问题，可以通过以下方式寻求支持：

- 团队内部技术群
- 项目GitHub Issues
- 项目维护人员

---

**更新时间**：2026-01-16
**文档版本**：v1.0
**适用项目**：ConsensusWeaverAgent
